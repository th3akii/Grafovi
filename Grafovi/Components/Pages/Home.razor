@page "/"
@rendermode InteractiveServer
@using Grafovi.Models
@inject IJSRuntime JS

<PageTitle>Grafovi</PageTitle>

<div class="graph-container">
    <!-- Levi Panel -->
    <div class="graph-panel">
        <div class="graph-header">
            <h2>Graf</h2>
        </div>
        <div id="graphCanvas" class="graph-canvas">
            <p class="graph-placeholder">Unesite grane da biste kreirali graf</p>
        </div>
    </div>

    <!-- Desni Panel -->
    <div class="control-panel">
        <!-- Unos -->
        <div class="panel-section">
            <h3>Unos Grafa</h3>
            <p class="section-description">Unesite grane grafa u formatu AB (grana između čvorova A i B)</p>
            
            <div class="input-group-inline">
                <label>
                    <span>Težinski graf</span>
                    <input type="checkbox" @bind="tezinskiGraf" class="toggle-switch" />
                </label>
            </div>

            <div class="input-group-inline">
                <label>
                    <span>Usmeren graf</span>
                    <input type="checkbox" @bind="usmerenGraf" class="toggle-switch" />
                </label>
            </div>

            <div class="input-group">
                <label>Grana (npr. AB, CD)</label>
                <input type="text" @bind="granaInput" placeholder="AB" class="input-field" />
            </div>

            @if (tezinskiGraf)
            {
                <div class="input-group">
                    <label>Težina</label>
                    <input type="number" @bind="tezinaInput" placeholder="1.0" class="input-field" step="0.1" />
                </div>
            }

            <div class="button-group">
                <button @onclick="DodajGranu" class="btn btn-primary">
                    <span>+</span> Dodaj granu
                </button>
                <button @onclick="ObrisiSve" class="btn btn-delete">
                    <span>🗑</span>
                </button>
            </div>
        </div>

        <!-- Info -->
        <div class="panel-section">
            <h3>Informacije o Grafu</h3>
            <p class="section-description">Pregled čvorova i grana</p>
            
            <div class="info-cards">
                <div class="info-card info-card-blue">
                    <div class="info-label">Broj čvorova</div>
                    <div class="info-value">@graf.cvorovi.Count</div>
                </div>
                <div class="info-card info-card-green">
                    <div class="info-label">Broj grana</div>
                    <div class="info-value">@graf.grane.Count</div>
                </div>
            </div>

            <div class="info-details">
                <div class="info-item">
                    <strong>Čvorovi:</strong>
                    @if (graf.cvorovi.Count > 0)
                    {
                        @foreach (var cvor in graf.cvorovi)
                        {
                            <span class ="item-tag-cvor">
                                @cvor.naziv
                                <button @onclick = "() => ObrisiCvor(cvor)" class="delete-btn">x</button>
                            </span>
                        }
                    }
                    else
                    {
                        <p>Nema čvorova</p>
                    }
                </div>
                <div class="info-item">
                    <strong>Grane:</strong>
                    @if (graf.grane.Count > 0)
                    {
                        @foreach (var grana in graf.grane)
                        {
                            <span class ="item-tag-grana">
                                @grana.pocetniCvor.naziv - @grana.krajnjiCvor.naziv
                                <button @onclick = "() => ObrisiGranu(grana)" class="delete-btn">x</button>
                            </span>
                        }
                    }
                    else
                    {
                        <p>Nema grana</p>
                    }
                    
                </div>
            </div>

            <div class="export-section">
                <strong>Uvoz/izvoz:</strong>
                <div class="button-group">
                    <button @onclick="ExportujGraf" class="btn btn-secondary">
                        <span>⬇</span> Exportuj
                    </button>
                    <InputFile OnChange="ImportujGraf" id="fileInput" style="display: none;" accept=".json" />
                    <label for="fileInput" class="btn btn-secondary" style="cursor: pointer;">
                        <span>⬆</span> Importuj
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    Graf graf = new Graf();
    bool tezinskiGraf = false;
    bool usmerenGraf = false;
    string granaInput = "";
    double tezinaInput = 1.0;

    protected override void OnInitialized()
    {
        // Prazan graf na pocetku
    }

    async void DodajGranu()
    {
        if (string.IsNullOrWhiteSpace(granaInput) || granaInput.Length < 2 || granaInput.Length > 2)
        {
            granaInput = "";
            return;
        }

        string pocetniNaziv = granaInput[0].ToString().ToUpper();
        string krajnjiNaziv = granaInput[1].ToString().ToUpper();
        
        graf.Dodaj(pocetniNaziv, krajnjiNaziv, tezinskiGraf ? tezinaInput : Convert.ToDouble(null), usmerenGraf);

        granaInput = "";
        tezinaInput = 1.0;
    }

    void ObrisiSve()
    {
        graf.cvorovi.Clear();
        graf.grane.Clear();
    }

    void ObrisiCvor(GrafCvor cvor)
    {
        graf.ObrisiCvor(cvor);
    }

    void ObrisiGranu(GrafGrana grana)
    {
        graf.ObrisiGranu(grana);
    }

    async Task ExportujGraf()
    {
        try
        {
            var options = new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            };
            var json = System.Text.Json.JsonSerializer.Serialize(graf, options);
            await JS.InvokeVoidAsync("downloadFile", "graf.json", json);
        }
        catch (Exception)
        {
            await JS.InvokeVoidAsync("alert", "Došlo je do greške prilikom eksportovanja grafa.");
        }
    }

    async Task ImportujGraf(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null)
                return;

            var stream = file.OpenReadStream();
            var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();

            var importovaniGraf = System.Text.Json.JsonSerializer.Deserialize<Graf>(json);

            if (importovaniGraf != null)
            {
                graf = importovaniGraf;
                await JS.InvokeVoidAsync("alert", "Graf je uspešno importovan!");
            }
        }
        catch (Exception)
        {
            await JS.InvokeVoidAsync("alert", "Došlo je do greške prilikom importovanja grafa.");
        }
        await Task.CompletedTask;
    }
}