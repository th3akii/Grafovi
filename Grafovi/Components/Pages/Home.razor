@page "/"
@using Grafovi.Models
@using System.Threading.Tasks
@using System.Xml.Serialization
@using Grafovi.Models.Algoritmi
@using Grafovi.Models.Komande
@using Grafovi.Services
@using System.Runtime.InteropServices
@inject IJSRuntime JS
@inject GraphStateService GraphState
@inject NavigationManager Navigation

<PageTitle>Grafovi</PageTitle>

<div class="graph-container">
    <!-- Levi Panel -->
    <div class="graph-panel">
        <div class="graph-header">
            <h2>Graf</h2>
        </div>        
        <div class="graph-content-wrapper">
            <div class="canvas-controls">
                <button @onclick="Undo" class="canvas-btn" title="Undo (Ctrl+Z)" disabled="@(!MozeUndo())">
                    <span>↶</span>
                </button>
                <button @onclick="Redo" class="canvas-btn" title="Redo (Ctrl+Y)" disabled="@(!MozeRedo())">
                    <span>↷</span>
                </button>
                <button @onclick="RefreshGraf"class="canvas-btn" title="Ponovo generisi">
                    <span>⟳</span>
                </button>
                <button @onclick="ToggleSettings" class="canvas-btn" title="Podesavanja">
                    <span>⚙</span>
                </button>
            </div>

            @if (graf.cvorovi.Count == 0)
            {
                <div class="graph-canvas graph-canvas-placeholder">
                    <p class="graph-placeholder">Unesite grane da biste kreirali graf</p>
                </div>
            }
            else
            {
                <div id="graphCanvas" class="graph-canvas"></div>
            }
        </div>
    </div>

    <!-- Desni Panel -->
    <div class="control-panel" style="@(activeTab == "algoritmi" ? "min-height: 450px;" : "")">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab @(activeTab == "unos" ? "active" : "")" @onclick='() => activeTab = "unos"'>
                Unos
            </button>
            <button class="tab @(activeTab == "informacije" ? "active" : "")" @onclick='() => activeTab = "informacije"'>
                Informacije
            </button>
            <button class="tab @(activeTab == "algoritmi" ? "active" : "")" @onclick='() => activeTab = "algoritmi"'>
                Algoritmi
            </button>
        </div>

        <!-- Tabovi -->
        <div class="tab-content">
            @if (activeTab == "unos")
            {
                <!-- Unos -->
                <div class="panel-section">
                    <h3>Unos Grafa</h3>
                    <p class="section-description">Unesite grane grafa u formatu AB (grana izmedu cvorova A i B)</p>
                    
                    <div class="input-group-inline">
                        <label>
                            <span>Težinski graf</span>
                            <input type="checkbox" class="toggle-switch" checked="@tezinskiGraf" @onchange="OnTezinskiGrafChanged" />
                        </label>
                    </div>

                    <div class="input-group-inline">
                        <label>
                            <span>Usmeren graf</span>
                            <input disabled="@(graf.grane.Count > 0)" type="checkbox" @bind="usmerenGraf" class="toggle-switch" />
                        </label>
                    </div>

                    <div class="input-group">
                        <label>Grana (npr. AB, CD)</label>
                        <input type="text" @bind="granaInput" @bind:event="oninput" placeholder="AB" class="input-field" @onkeydown="GranaUnosEnter" maxlength="2" />
                    </div>

                    @if (tezinskiGraf)
                    {
                        <div class="input-group">
                            <label>Težina</label>
                            <input type="number" @bind="tezinaInput" @bind:event="oninput" placeholder="1.0" class="input-field" step="0.1" @onkeydown="GranaUnosEnter" @onblur="DefaultTezina"/>
                        </div>
                    }

                    <div class="button-group">
                        <button @onclick="DodajGranu" class="btn btn-primary">
                            <span>+</span> Dodaj granu
                        </button>
                        <button @onclick="PotvrdiBrisanjeSvega" class="btn btn-delete">
                            <span>🗑</span>
                        </button>
                    </div>

                    <div class="export-section">
                        <strong>Uvoz/izvoz:</strong>
                        <div class="button-group">
                            <button @onclick="ExportujGraf" class="btn btn-secondary">
                                <span>⬇</span> Exportuj
                            </button>
                            <InputFile OnChange="ImportujGraf" id="fileInput" style="display: none;" accept=".json" />
                            <label for="fileInput" class="btn btn-secondary" style="cursor: pointer;">
                                <span>⬆</span> Importuj
                            </label>
                        </div>
                    </div>
                </div>
            }
            else if (activeTab == "informacije")
            {
                <!-- Info -->
                <div class="panel-section">
                    <h3>Informacije o Grafu</h3>
                    <p class="section-description">Pregled cvorova i grana</p>
                    
                    <div class="info-cards">
                        <div class="info-card info-card-blue">
                            <div class="info-label">Broj cvorova</div>
                            <div class="info-value">@graf.cvorovi.Count</div>
                        </div>
                        <div class="info-card info-card-green">
                            <div class="info-label">Broj grana</div>
                            <div class="info-value">@graf.grane.Count</div>
                        </div>
                    </div>

                    <div class="info-details">
                        <div class="info-item">
                            <strong>Cvorovi:</strong>
                            @if (graf.cvorovi.Count > 0)
                            {
                                @foreach (var cvor in graf.cvorovi)
                                {
                                    <span class ="item-tag-cvor">
                                        @cvor.naziv
                                        <button @onclick = "() => ObrisiCvor(cvor)" class="delete-btn">x</button>
                                    </span>
                                }
                            }
                            else
                            {
                                <p>Nema cvorova</p>
                            }
                        </div>
                        <div class="info-item">
                            <strong>Grane:</strong>
                            @if (graf.grane.Count > 0)
                            {
                                @foreach (var grana in graf.grane)
                                {
                                    <div class="item-tag-grana">
                                        <span class="grana-label">@grana.pocetniCvor.naziv - @grana.krajnjiCvor.naziv</span>
                                        <div class="grana-controls">
                                            <input type="number" class="weight-input"
                                                    value="@grana.tezina" 
                                                    @oninput="(e) => OnTezinaChanged(e, grana)" 
                                                    step="0.1" 
                                                    disabled="@(!tezinskiGraf)"
                                                    @onkeydown="(e) => AzurirajTezinuEnter(e, grana)"/> 
                                            <button @onclick="() => ObrisiGranu(grana)" class="delete-btn">x</button>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <p>Nema grana</p>
                            }
                            
                        </div>
                    </div>
                </div>
            }
            else if (activeTab == "algoritmi")
            {
                <!-- Algoritmi -->
                <div class="panel-section">
                    <h3>Algoritmi</h3>
                    <p class="section-description">Odaberite algoritam</p>
                    
                    <div class="input-group">
                        <label>Izaberite algoritam</label>
                        <div class="custom-select-container">
                            <div class="custom-select-trigger" @onclick="ToggleDropdown">
                                <span>@(string.IsNullOrEmpty(odabraniAlgoritam) ? "Izaberite algoritam" : GetAlgoritamNaziv(odabraniAlgoritam))</span>
                                <span class="arrow">▼</span>
                            </div>
                            @if (dropdown)
                            {
                                <div class="custom-options">
                                    <div class="custom-option @(odabraniAlgoritam == "povezanost" ? "selected" : "")" 
                                         @onclick='() => SelectAlgorithm("povezanost")'>
                                        Provera povezanosti
                                    </div>
                                    <div class="custom-option @(odabraniAlgoritam == "dajkstra" ? "selected" : "")" 
                                         @onclick='() => SelectAlgorithm("dajkstra")'>
                                        Dajkstra
                                    </div>
                                    <div class="custom-option @(odabraniAlgoritam == "kruskal" ? "selected" : "")" 
                                         @onclick='() => SelectAlgorithm("kruskal")'>
                                        Kruskal
                                    </div>
                                    <div class="custom-option @(odabraniAlgoritam == "prim" ? "selected" : "")" 
                                         @onclick='() => SelectAlgorithm("prim")'>
                                        Prim
                                    </div>
                                    <div class="custom-option @(odabraniAlgoritam == "belman-ford" ? "selected" : "")" 
                                         @onclick='() => SelectAlgorithm("belman-ford")'>
                                        Belman-Ford
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    @if (odabraniAlgoritam == "dajkstra")
                    {
                        <div class="input-group">
                            <label>Pocetni cvor</label>
                            <div class="custom-select-container">
                                <div class="custom-select-trigger" @onclick="ToggleDropdownPocetniCvor">
                                    <span>@(string.IsNullOrEmpty(pocetniCvorDajkstra) ? "Izaberite pocetni cvor" : $"Cvor {pocetniCvorDajkstra}")</span>
                                    <span class="arrow">▼</span>
                                </div>
                                @if (dropdownPocetniCvor)
                                {
                                    <div class="custom-options">
                                        @foreach (var cvor in graf.cvorovi)
                                        {
                                            <div class="custom-option @(pocetniCvorDajkstra == cvor.naziv ? "selected" : "")" 
                                                 @onclick='() => SelectPocetniCvor(cvor.naziv)'>
                                                Cvor @cvor.naziv
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    @if (odabraniAlgoritam == "belman-ford")
                    {
                        <div class="input-group">
                            <label>Pocetni cvor</label>
                            <div class="custom-select-container">
                                <div class="custom-select-trigger" @onclick="ToggleDropdownPocetniCvor">
                                    <span>@(string.IsNullOrEmpty(pocetniCvorDajkstra) ? "Izaberite pocetni cvor" : $"Cvor {pocetniCvorDajkstra}")</span>
                                    <span class="arrow">▼</span>
                                </div>
                                @if (dropdownPocetniCvor)
                                {
                                    <div class="custom-options">
                                        @foreach (var cvor in graf.cvorovi)
                                        {
                                            <div class="custom-option @(pocetniCvorDajkstra == cvor.naziv ? "selected" : "")" 
                                                 @onclick='() => SelectPocetniCvor(cvor.naziv)'>
                                                Cvor @cvor.naziv
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div style="margin-top: 16px;">
                        <button @onclick="PokreniAlgoritam" class="btn btn-primary" style="width: 100%;">Pokreni algoritam</button>
                    </div>

                    @if (prikaziRezultat)
                    {
                        @if (odabraniAlgoritam == "povezanost")
                        {
                            <div class="result-box">
                                <h4>Rezultat:</h4>
                                @if (rezultatJePovezan)
                                {
                                    <div class="result-success">
                                        <span class="icon">✅</span>
                                        <span>Graf je povezan</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="result-error">
                                        <span class="icon">❌</span>
                                        <span>Graf nije povezan - pronadeno je @grupeCvorova.Count komponenti povezanosti</span>
                                    </div>
                                }

                                @for (int i = 0; i < grupeCvorova.Count; i++)
                                {
                                    <div style="margin-bottom: 12px;">
                                        <p style="font-weight: 600; margin-bottom: 4px;">Grupa @(i + 1):</p>
                                        <div class="visited-nodes">
                                            @foreach (var cvor in grupeCvorova[i].OrderBy(c => c.naziv))
                                            {
                                                <span class="node-badge">@cvor.naziv</span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else if (odabraniAlgoritam == "dajkstra")
                        {
                            <div class="result-box">
                                @if (dajkstraNegativnaTezina)
                                {
                                    <div style="padding: 15px; background-color: #fee2e2; border-left: 4px solid #dc2626; border-radius: 4px; margin-bottom: 12px;">
                                        <p style="margin: 0; color: #dc2626; font-weight: 600;">⚠️ Greška: Graf sadrži grane sa negativnom težinom, Dajkstrin algoritam ne može biti primenjen!</p>
                                    </div>
                                    dajkstraNegativnaTezina = false;
                                    odabraniAlgoritam = "dajkstra";
                                }
                                else if (dajkstraRezultati.Any())
                                {
                                    <h4>Rezultat:</h4>
                                    <p style="margin-bottom: 10px;">Najkrace udaljenosti od cvora @pocetniCvorDajkstra:</p>
                                    
                                    <div class="dajkstra-results">
                                        @foreach (DajkstraRezultat rezultat in dajkstraRezultati)
                                        {
                                            <div class="dajkstra-result-card">
                                                <div class="dajkstra-result-header">
                                                    <span class="dajkstra-target-node">Do cvora @rezultat.cvor:</span>
                                                    <span class="dajkstra-distance-badge">@(rezultat.udaljenost == double.MaxValue ? "8" : rezultat.udaljenost.ToString())</span>
                                                </div>
                                                <div class="dajkstra-path">
                                                    @if (rezultat.udaljenost == double.MaxValue)
                                                    {
                                                        <span>Nije dostupan</span>
                                                    }
                                                    else
                                                    {
                                                        <span>Put: @rezultat.put</span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else if (odabraniAlgoritam == "kruskal")
                        {
                            <div class="result-box">
                                <h4>Rezultat:</h4>
                                <p>@kruskalRezultat</p>
                                @if (kruskalUkupnaTezina > 0)
                                {
                                    <div class="total-weight-display">
                                        <strong>Ukupna težina: @kruskalUkupnaTezina</strong>
                                    </div>
                                }
                            </div>
                        }
                        else if (odabraniAlgoritam == "prim")
                        {
                            <div class="result-box">
                                <h4>Rezultat:</h4>
                                <p>@primRezultat</p>
                                @if (primUkupnaTezina > 0)
                                {
                                    <div class="total-weight-display">
                                        <strong>Ukupna težina: @primUkupnaTezina</strong>
                                    </div>
                                }
                            </div> 
                        }
                        else if (odabraniAlgoritam == "belman-ford")
                        {
                            <div class="result-box">
                                <h4>Rezultat:</h4>
                                
                                @if (belmanFordNegativanCiklus)
                                {
                                    <div style="padding: 15px; background-color: #fee2e2; border-left: 4px solid #dc2626; border-radius: 4px;">
                                        <p style="margin: 0; color: #dc2626; font-weight: 600;">?? Greška: Graf sadrži negativan ciklus!</p>
                                    </div>
                                }
                                else if (belmanFordRezultati.Any())
                                {
                                    <p style="margin-bottom: 10px; color: #4b5563;">Najkrace udaljenosti od cvora @pocetniCvorDajkstra:</p>
                                    <div class="dajkstra-results">
                                        @foreach (BelmanFordRezultat rezultat in belmanFordRezultati)
                                        {
                                            <div class="dajkstra-result-card">
                                                <div class="dajkstra-result-header">
                                                    <span class="dajkstra-target-node">Do cvora @rezultat.cvor:</span>
                                                    <span class="dajkstra-distance-badge">@(rezultat.udaljenost == double.MaxValue ? "8" : rezultat.udaljenost.ToString())</span>
                                                </div>
                                                <div class="dajkstra-path">
                                                    @if (rezultat.udaljenost == double.MaxValue)
                                                    {
                                                        <span>Nije dostupan</span>
                                                    }
                                                    else
                                                    {
                                                        <span>Put: @rezultat.put</span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }

                    @if (graf.cvorovi.Count == 0)
                    {
                        <div class="alert-box">
                            Morate prvo kreirati graf da biste primenili algoritme!
                        </div>
                    }
                </div>

            }
        </div>
    </div>
</div>



<!-- Settings Modal -->
@if (prikaziPodesavanja)
{
    <div class="modal-backdrop">
        <div class="settings-modal">
            <div class="modal-header">
                <h3>Podešavanja Vizualizacije</h3>
                <button @onclick="ToggleSettings" class="close-btn">×</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Boja cvorova</label>
                    <input type="color" @bind="tempBojaCvora" class="color-picker" />
                </div>
                <div class="input-group">
                    <label>Boja grana</label>
                    <input type="color" @bind="tempBojaGrane" class="color-picker" />
                </div>
                <div class="input-group">
                    <label>Velicina cvorova (@tempVelicinaCvora)</label>
                    <input type="range" @bind="tempVelicinaCvora" min="10" max="50" class="range-slider" />
                </div>
                <div class="input-group-inline">
                    <label>
                        <span>Zadrži pozicije (ne resetuj graf)</span>
                        <input type="checkbox" @bind="tempCuvajPoziciju" class="toggle-switch" />
                    </label>
                </div>
                <div class="input-group-inline">
                    <label>
                        <span>Zakljucaj pomeranje</span>
                        <input type="checkbox" @bind="tempZakljucanoPomeranje" class="toggle-switch" />
                    </label>
                </div>
                <div class="input-group-inline">
                    <label>
                        <span>Omoguci menjanje grana</span>
                        <input type="checkbox" @bind="tempOmoguciMenjanjeGrana" class="toggle-switch" />
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button @onclick="ApplySettings" class="btn btn-primary">Primeni</button>
            </div>
        </div>
    </div>
}

@code {
    Graf graf 
    {
        get => GraphState.Graf;
        set => GraphState.Graf = value;
    }
    
    bool tezinskiGraf 
    {
        get => GraphState.TezinskiGraf;
        set => GraphState.TezinskiGraf = value;
    }
    
    bool usmerenGraf 
    {
        get => GraphState.UsmerenGraf;
        set => GraphState.UsmerenGraf = value;
    }

    string granaInput = "";
    double? tezinaInput = 1.0;
    string activeTab = "unos";
    string odabraniAlgoritam = "";
    bool dropdown = false;
    bool zaRenderovanje = false;

    bool prikaziPodesavanja = false;
    string tempBojaCvora = "#97C2FC";
    string tempBojaGrane = "#2B7CE9";
    int tempVelicinaCvora = 16;
    bool tempZakljucanoPomeranje = false;
    bool tempCuvajPoziciju = false;
    bool tempOmoguciMenjanjeGrana = false;

    string bojaCvora => GraphState.BojaCvora;
    string bojaGrane => GraphState.BojaGrane;
    int velicinaCvora => GraphState.VelicinaCvora;
    bool zakljucanoPomeranje => GraphState.ZakljucanoPomeranje;
    bool cuvajPoziciju => GraphState.CuvajPoziciju;
    bool omoguciMenjanjeGrana => GraphState.OmoguciMenjanjeGrana;
    bool prikaziRezultat = false;

    bool rezultatJePovezan = false;
    List<List<GrafCvor>> grupeCvorova = new List<List<GrafCvor>>();
    string kruskalRezultat = "";
    double kruskalUkupnaTezina = 0;
    string primRezultat = "";
    double primUkupnaTezina = 0;

    bool dropdownPocetniCvor = false;
    List<DajkstraRezultat> dajkstraRezultati = new List<DajkstraRezultat>();
    string pocetniCvorDajkstra = "";
    bool dajkstraNegativnaTezina = false;
    List<BelmanFordRezultat> belmanFordRezultati = new List<BelmanFordRezultat>();
    bool belmanFordNegativanCiklus = false;

    protected override async Task OnInitializedAsync()
    {
        if (graf.cvorovi.Count > 0)
        {
            zaRenderovanje = true;
        }

        var dotNetHelper = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("setupKeyboardShortcuts", dotNetHelper);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (zaRenderovanje)
        {
            zaRenderovanje = false;
            if (graf.cvorovi.Count > 0)
            {
                await RenderGraf();
            }
        }
    }

    async Task DodajGranu()
    {
        if (string.IsNullOrWhiteSpace(granaInput))
        {
            granaInput = "";
            return;
        }

        if (granaInput.Length == 1)
        {
            string cvor = granaInput[0].ToString().ToUpper();
            var komanda = new KomandaDodajCvor(cvor);
            IzvrsiKomandu(komanda);
            granaInput = "";
            tezinaInput = 1.0;
            zaRenderovanje = true;
            return;
        }

        string pocetniNaziv = granaInput[0].ToString().ToUpper();
        string krajnjiNaziv = granaInput[1].ToString().ToUpper();

        try
        {
            var komanda = new KomandaDodajGranu(pocetniNaziv, krajnjiNaziv, tezinaInput ?? 1.0, usmerenGraf);
            IzvrsiKomandu(komanda);
            granaInput = "";
            tezinaInput = 1.0;
            zaRenderovanje = true;
        }
        catch (InvalidOperationException ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }

    async Task GranaUnosEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await DodajGranu();
        }
    }

    async Task PotvrdiBrisanjeSvega()
    {
        if (graf.cvorovi.Count == 0)
        {
            return;
        }

        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Da li ste sigurni da želite da obrišete sve cvorove i grane?");
        if (confirmed)
        {
            await ObrisiSve();
        }
    }

    async Task ObrisiSve()
    {
        var komanda = new KomandaObrisiSve();
        IzvrsiKomandu(komanda);
        graf.cvorovi.Clear();
        graf.grane.Clear();
        await ObrisiGraf();
        ResetSettings();
    }

    async Task ObrisiGraf()
    {
        try
        {
            await JS.InvokeVoidAsync("clearGraph", "graphCanvas");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error clearing graph: {ex.Message}");
        }
    }

    async Task ObrisiCvor(GrafCvor cvor)
    {
        var komanda = new KomandaObrisiCvor(cvor.ID);
        IzvrsiKomandu(komanda);
        graf.ObrisiCvor(cvor);
        zaRenderovanje = true;
        await Task.CompletedTask;
    }

    async Task ObrisiGranu(GrafGrana grana)
    {
        var komanda = new KomandaObrisiGranu(grana.ID);
        IzvrsiKomandu(komanda);
        graf.ObrisiGranu(grana);
        zaRenderovanje = true;
        await Task.CompletedTask;
    }

    void ToggleDropdown()
    {
        dropdown = !dropdown;
    }

    void ToggleDropdownPocetniCvor()
    {
        dropdownPocetniCvor = !dropdownPocetniCvor;
    }

    void SelectAlgorithm(string algoritam)
    {
        odabraniAlgoritam = algoritam;
        dropdown = false;
        prikaziRezultat = false;
    }

    void SelectPocetniCvor(string cvor)
    {
        pocetniCvorDajkstra = cvor;
        dropdownPocetniCvor = false;
    }

    string GetAlgoritamNaziv(string algoritam)
    {
        return algoritam switch
        {
            "povezanost" => "Provera povezanosti",
            "dajkstra" => "Dajkstra",
            "kruskal" => "Kruskal",
            "prim" => "Prim",
            "belman-ford" => "Belman-Ford",
            _ => "Izaberite algoritam"
        };
    }

    async Task PokreniAlgoritam()
    {
        if (graf.cvorovi.Count == 0)
        {
            await JS.InvokeVoidAsync("alert", "Nema cvorova u grafu. Dodajte grane pre pokretanja algoritma.");
            return;
        }
        
        prikaziRezultat = false;

        if (odabraniAlgoritam == "povezanost")
        {
            RezultatPovezanosti? rezultat = GrafAlgoritamPovezan.DaLiJePovezanLista(graf);
            
            prikaziRezultat = true;
            rezultatJePovezan = rezultat.jePovezan;
            grupeCvorova = rezultat.cvoroviUGrupi;
        }
        else if (odabraniAlgoritam == "dajkstra")
        {
            if (string.IsNullOrEmpty(pocetniCvorDajkstra))
            {
                await JS.InvokeVoidAsync("alert", "Izaberite pocetni cvor.");
                return;
            }

            if (graf.grane.Any(g => g.tezina < 0))
            {
                dajkstraNegativnaTezina = true;
                prikaziRezultat = true;
                return;
            }

            RezultatPovezanosti? rezultat = GrafAlgoritamPovezan.DaLiJePovezanLista(graf);
            
            if(!rezultat.jePovezan)
            {
                odabraniAlgoritam = "povezanost";
                prikaziRezultat = true;
                rezultatJePovezan = rezultat.jePovezan;
                grupeCvorova = rezultat.cvoroviUGrupi;
            }

            GrafCvor? pocetni = graf.cvorovi.FirstOrDefault(c => c.naziv == pocetniCvorDajkstra);
            if (pocetni != null)
            {
                ///*Lista
                var alg = new GrafAlgoritamDajkstra();
                
                dajkstraRezultati = alg.DajkstraLista(graf, pocetni);
                
                prikaziRezultat = true;
                //*/
                
                /* Matrica
                var alg = new GrafAlgoritamDajkstra();

                dajkstraRezultati = alg.DajkstraMatrica(graf, pocetni);

                prikaziRezultat = true;
                */
            }
        }
        else if (odabraniAlgoritam == "kruskal")
        {
            var alg = new GrafAlgoritamKruskal();
            var rezultat = alg.KruskalAlgoritam(graf);

            foreach (var grana in rezultat.graneZaBrisanje)
            {
                await ObrisiGranu(grana);
            }
            kruskalUkupnaTezina = rezultat.ukupnaTezina;
            kruskalRezultat = "Kruskalov algoritam je uspešno izvršen.";
            prikaziRezultat = true;
        }
        else if (odabraniAlgoritam == "prim")
        {
            RezultatPovezanosti? rezultatPovezanosti = GrafAlgoritamPovezan.DaLiJePovezanLista(graf);
            
            if(!rezultatPovezanosti.jePovezan)
            {
                odabraniAlgoritam = "povezanost";
                prikaziRezultat = true;
                rezultatJePovezan = rezultatPovezanosti.jePovezan;
                grupeCvorova = rezultatPovezanosti.cvoroviUGrupi;
            }
            else
            {
                if (!tezinskiGraf)
                {
                    primRezultat = "Primov algoritam zahteva težinski graf.";
                    prikaziRezultat = true;
                    return;
                }

                var alg = new GrafAlgoritamPrim();
                var rezultat = alg.PrimovAlgoritam(graf);

                foreach (var grana in rezultat.graneZaBrisanje)
                {
                    await ObrisiGranu(grana);
                }
                primUkupnaTezina = rezultat.ukupnaTezina;
                primRezultat = "Primov algoritam je uspešno izvršen.";
                prikaziRezultat = true;
            }
        }
        else if (odabraniAlgoritam == "belman-ford")
        {
            if (string.IsNullOrEmpty(pocetniCvorDajkstra))
            {
                await JS.InvokeVoidAsync("alert", "Izaberite pocetni cvor.");
                return;
            }

            RezultatPovezanosti? rezultat = GrafAlgoritamPovezan.DaLiJePovezanLista(graf);
            
            if(!rezultat.jePovezan)
            {
                odabraniAlgoritam = "povezanost";
                prikaziRezultat = true;
                rezultatJePovezan = rezultat.jePovezan;
                grupeCvorova = rezultat.cvoroviUGrupi;
            }

            GrafCvor? pocetni = graf.cvorovi.FirstOrDefault(c => c.naziv == pocetniCvorDajkstra);
            if (pocetni != null)
            {
                var alg = new GrafAlgoritamBelmanFord();
                
                var rezultatBelmanFord = alg.BelmanFordLista(graf, pocetni);
                
                if (rezultatBelmanFord == null)
                {
                    belmanFordNegativanCiklus = true;
                    belmanFordRezultati = new List<BelmanFordRezultat>();
                }
                else
                {
                    belmanFordNegativanCiklus = false;
                    belmanFordRezultati = rezultatBelmanFord;
                }
                
                prikaziRezultat = true;
            }
        }
    }

    async Task ExportujGraf()
    {
        try
        {
            graf.usmeren = usmerenGraf;
            graf.tezinski = tezinskiGraf;

            var options = new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            };
            var json = System.Text.Json.JsonSerializer.Serialize(graf, options);
            await JS.InvokeVoidAsync("downloadFile", "graf.json", json);
        }
        catch (Exception)
        {
            await JS.InvokeVoidAsync("alert", "Došlo je do greške prilikom eksportovanja grafa.");
        }
    }

    async Task ImportujGraf(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null)
                return;

            var stream = file.OpenReadStream();
            var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();

            var importovaniGraf = System.Text.Json.JsonSerializer.Deserialize<Graf>(json);

            if (importovaniGraf != null)
            {
                await ObrisiSve();
                foreach (var grana in importovaniGraf.grane)
                {
                    var pocetni = importovaniGraf.cvorovi.FirstOrDefault(c => c.ID == grana.pocetniCvor.ID);
                    var krajnji = importovaniGraf.cvorovi.FirstOrDefault(c => c.ID == grana.krajnjiCvor.ID);

                    if (pocetni != null) grana.pocetniCvor = pocetni;
                    if (krajnji != null) grana.krajnjiCvor = krajnji;
                }

                graf = importovaniGraf;

                usmerenGraf = graf.usmeren;
                tezinskiGraf = graf.tezinski;

                await JS.InvokeVoidAsync("alert", "Graf je uspešno importovan!");
                zaRenderovanje = true;
            }
        }
        catch (Exception)
        {
            await JS.InvokeVoidAsync("alert", "Došlo je do greške prilikom importovanja grafa.");
        }
        await Task.CompletedTask;
    }

    async Task RenderGraf()
    {
        try
        {
            await Task.Delay(50);
            var settings = new
            {
                bojaCvora,
                bojaGrane,
                velicinaCvora,
                zakljucanoPomeranje,
                cuvajPoziciju,
                omoguciMenjanjeGrana
            };
            var dotNetHelper = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("renderGraph", "graphCanvas", graf.cvorovi, graf.grane, usmerenGraf, tezinskiGraf, settings, dotNetHelper);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering graph: {ex.Message}");
        }
    }

    [JSInvokable]
    public void AzurirajGranu(string edgeId, string fromId, string toId)
    {
        var grana = graf.grane.FirstOrDefault(g => g.ID == edgeId);
        if (grana != null)
        {
            var pocetni = graf.cvorovi.FirstOrDefault(c => c.naziv == fromId) 
                          ?? graf.cvorovi.FirstOrDefault(c => c.ID.ToString() == fromId);
            
            var krajnji = graf.cvorovi.FirstOrDefault(c => c.naziv == toId)
                          ?? graf.cvorovi.FirstOrDefault(c => c.ID.ToString() == toId);

            if (pocetni != null && krajnji != null)
            {
                grana.pocetniCvor = pocetni;
                grana.krajnjiCvor = krajnji;
                
                Console.WriteLine($"Grana {edgeId} azurirana: {pocetni.naziv} -> {krajnji.naziv}");
                StateHasChanged();
            }
        }
    }

    async Task AzurirajTezinuEnter(KeyboardEventArgs e, GrafGrana grana)
    {
        if (e.Key == "Enter")
        {
            await AzurirajTezinu(grana);
        }
    }

    async Task OnTezinaChanged(ChangeEventArgs e, GrafGrana grana)
    {
        if (double.TryParse(e.Value?.ToString(), out double novaTezina))
        {
            if (grana.tezina != novaTezina)
            {
                var komanda = new KomandaPromeniTezinu(grana.ID, novaTezina);
                IzvrsiKomandu(komanda);
                await AzurirajTezinu(grana);
            }
        }
    }

    void RefreshGraf()
    {
        ResetSettings();
        zaRenderovanje = true;
    }

    void ToggleSettings()
    {
        if (!prikaziPodesavanja)
        {
            LoadTempSettings();
            prikaziPodesavanja = true;
        }
        else
        {
            prikaziPodesavanja = false;
        }
    }

    void LoadTempSettings()
    {
        tempBojaCvora = GraphState.BojaCvora;
        tempBojaGrane = GraphState.BojaGrane;
        tempVelicinaCvora = GraphState.VelicinaCvora;
        tempZakljucanoPomeranje = GraphState.ZakljucanoPomeranje;
        tempCuvajPoziciju = GraphState.CuvajPoziciju;
        tempOmoguciMenjanjeGrana = GraphState.OmoguciMenjanjeGrana;
    }

    async Task ApplySettings()
    {
        GraphState.BojaCvora = tempBojaCvora;
        GraphState.BojaGrane = tempBojaGrane;
        GraphState.VelicinaCvora = tempVelicinaCvora;
        GraphState.ZakljucanoPomeranje = tempZakljucanoPomeranje;
        GraphState.CuvajPoziciju = tempCuvajPoziciju;
        GraphState.OmoguciMenjanjeGrana = tempOmoguciMenjanjeGrana;

        prikaziPodesavanja = false;

        if (graf.cvorovi.Count > 0)
        {
            await RenderGraf();
        }
    }

    void ResetSettings()
    {
        GraphState.ResetSettings();
        LoadTempSettings();
    }

    async Task OnTezinskiGrafChanged(ChangeEventArgs args)
    {
        var newValue = args.Value is bool checkedValue && checkedValue;
        if (tezinskiGraf == newValue)
        {
            return;
        }

        tezinskiGraf = newValue;
        graf.tezinski = newValue;

        if (graf.cvorovi.Count == 0)
        {
            zaRenderovanje = true;
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("updateEdgeLabels", "graphCanvas", graf.grane, newValue);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating edge labels: {ex.Message}");
            zaRenderovanje = true;
        }
    }

    async Task AzurirajTezinu(GrafGrana grana)
    {
        if (tezinskiGraf)
        {
            try
            {
                await JS.InvokeVoidAsync("updateEdgeLabels", "graphCanvas", new[] { grana }, true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error updating single edge label: {ex.Message}");
            }
        }
    }

    void DefaultTezina(FocusEventArgs e)
    {
        if (tezinaInput == null)
        {
            tezinaInput = 1.0;
        }
    }

    //Undo/Redo
    private Stack<IKomanda> undoStack = new Stack<IKomanda>();
    private Stack<IKomanda> redoStack = new Stack<IKomanda>();
    private const int maxStackSize = 100;

    bool MozeUndo() => undoStack.Count > 0;
    bool MozeRedo() => redoStack.Count > 0;

    void IzvrsiKomandu(IKomanda komanda)
    {
        komanda.Izvrsi(graf);
        undoStack.Push(komanda);
        redoStack.Clear();

        // obrce stek i brise najstariju komandu
        if (undoStack.Count > maxStackSize)
        {
            var pomStek = new Stack<IKomanda>(undoStack.Reverse().Skip(1).Reverse());
            undoStack = pomStek;
        }
    }

    async Task Undo()
    {
        if (!MozeUndo()) return;

        try
        {
            var komanda = undoStack.Pop();
            komanda.Ponisti(graf);
            redoStack.Push(komanda);

            zaRenderovanje = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("alert", $"Greška pri undo operaciji: {ex.Message}");
        }
    }

    async Task Redo()
    {
        if (!MozeRedo()) return;

        try
        {
            var komanda = redoStack.Pop();
            komanda.Izvrsi(graf);
            undoStack.Push(komanda);

            zaRenderovanje = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("alert", $"Greška pri redo operaciji: {ex.Message}");
        }
    }

    //Keyboard shortcuts
    [JSInvokable]
    public async Task PritisnutoDugme(KeyboardEventArgs e)
    {
        if (e.CtrlKey && e.Key.ToLower() == "z" && !e.ShiftKey)
        {
            await JS.InvokeVoidAsync("preventDefaultKeyEvent");
            await Undo();
            return;
        }

        if ((e.CtrlKey && e.Key.ToLower() == "y") ||
                (e.CtrlKey && e.ShiftKey && e.Key.ToLower() == "z"))
        {
            await JS.InvokeVoidAsync("preventDefaultKeyEvent");
            await Redo();
            return;
        }

        if (e.CtrlKey && e.Key.ToLower() == "s")
        {
            await JS.InvokeVoidAsync("preventDefaultKeyEvent");
            await ExportujGraf();
            return;
        }

        if (e.CtrlKey && e.Key.ToLower() == "o")
        {
            await JS.InvokeVoidAsync("preventDefaultKeyEvent");
            await JS.InvokeVoidAsync("triggerFileInput", "importFileInput");
            return;
        }

        if (e.CtrlKey && e.Key.ToLower() == "r")
        {
            await JS.InvokeVoidAsync("preventDefaultKeyEvent");
            RefreshGraf();
            return;
        }

        if (e.CtrlKey && e.Key.ToLower() == "p")
        {
            await JS.InvokeVoidAsync("preventDefaultKeyEvent");
            ToggleSettings();
            return;
        }

        if (e.Key == "Escape")
        {
            if (prikaziPodesavanja)
            {
                prikaziPodesavanja = false;
                StateHasChanged();
            }
            dropdown = false;
            dropdownPocetniCvor = false;
            StateHasChanged();
        }
    }
    [JSInvokable]
    public async Task HandleUndo() => await Undo();

    [JSInvokable]
    public async Task HandleRedo() => await Redo();

    [JSInvokable]
    public async Task HandleSave() => await ExportujGraf();

    [JSInvokable]
    public async Task HandleOpen() => await ImportujGraf(await JS.InvokeAsync<InputFileChangeEventArgs>("getFileInputEvent", "importFileInput"));

    [JSInvokable]
    public void HandleRefresh() { RefreshGraf(); StateHasChanged(); }

    [JSInvokable]
    public void HandleSettings() { ToggleSettings(); StateHasChanged(); }

    [JSInvokable]
    public void HandleEscape() 
    { 
        if (prikaziPodesavanja) prikaziPodesavanja = false;
        dropdown = false;
        dropdownPocetniCvor = false;
        StateHasChanged();
    }
}
